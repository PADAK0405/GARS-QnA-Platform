<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gaon QandA - 질문하기</title>
    <meta name="csrf-token" content="">
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700&display=swap" rel="stylesheet">
    <meta name="description" content="Gaon QandA에서 궁금한 점을 질문하고 커뮤니티의 도움을 받아보세요">
</head>
<body>
    <nav class="navbar">
        <a href="/" class="navbar-brand">Gaon QandA</a>
        <div id="auth-container"></div>
    </nav>
    <div class="container">
        <h1 class="page-title">새로운 질문하기</h1>
        <div class="card" id="question-form">
            <div class="form-group">
                <label for="question-title" style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-color);">질문 제목</label>
                <input type="text" id="question-title" placeholder="명확하고 간결한 제목을 입력하세요">
            </div>
            <div class="form-group">
                <label for="question-content" style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-color);">질문 내용</label>
                <textarea id="question-content" placeholder="궁금한 내용을 자세히 작성해주세요. 구체적일수록 더 좋은 답변을 받을 수 있습니다."></textarea>
            </div>
            <div class="form-group">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-color);">이미지 첨부 (선택)</label>
                <input type="file" id="question-image" accept="image/*" multiple style="display: none;">
                <button type="button" id="upload-image-btn" class="secondary-btn">이미지 선택</button>
                <div id="image-preview" class="image-preview"></div>
            </div>
            <button id="submit-question">질문 등록하기</button>
        </div>
    </div>
    <script src="protection.js"></script>
    <script src="script.js"></script>
    <script src="csrf.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', setupAskPage);
        
        let selectedImages = [];
        
        async function setupAskPage() {
            // script.js에서 이미 currentUser가 설정되어 있는지 확인
            if (typeof currentUser === 'undefined' || !currentUser) {
                // 사용자 정보 로드
                try {
                    const response = await fetch('/api/user');
                    if (!response.ok) {
                        window.location.href = '/';
                        return;
                    }
                    currentUser = await response.json();
                    console.log('ask.html에서 사용자 정보 로드:', currentUser);
                } catch (error) {
                    console.error('사용자 정보 로드 실패:', error);
                    window.location.href = '/';
                    return;
                }
            } else {
                console.log('script.js에서 이미 로드된 사용자 정보 사용:', currentUser);
            }
            
            setupEventListeners();
        }
        
        function setupEventListeners() {
            // 이미지 업로드 버튼
            const uploadBtn = document.getElementById('upload-image-btn');
            const imageInput = document.getElementById('question-image');
            
            uploadBtn.addEventListener('click', () => imageInput.click());
            imageInput.addEventListener('change', handleImageSelect);
            
            // 질문 제출 버튼
            const submitBtn = document.getElementById('submit-question');
            submitBtn.addEventListener('click', submitQuestion);
            
        }
        
        
        function handleImageSelect(event) {
            const files = Array.from(event.target.files);
            const maxFiles = 5;
            
            if (files.length > maxFiles) {
                showToast(`최대 ${maxFiles}개의 이미지만 업로드할 수 있습니다.`, 'error');
                return;
            }
            
            selectedImages = files;
            displayImagePreviews();
        }
        
        function displayImagePreviews() {
            const preview = document.getElementById('image-preview');
            preview.innerHTML = '';
            
            selectedImages.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.width = '100px';
                    img.style.height = '100px';
                    img.style.objectFit = 'cover';
                    img.style.borderRadius = '8px';
                    img.style.margin = '4px';
                    img.style.cursor = 'pointer';
                    
                    img.addEventListener('click', () => removeImage(index));
                    preview.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
        }
        //나도 이게 뭔지 모르겠다
        function removeImage(index) {
            selectedImages.splice(index, 1);
            displayImagePreviews();
        }
        
        let isSubmitting = false; // 중복 제출 방지 플래그
        
        async function submitQuestion() {
            // 이미 제출 중이면 무시
            if (isSubmitting) {
                console.log('이미 제출 중입니다. 중복 제출 방지');
                return;
            }
            
            const title = document.getElementById('question-title').value.trim();
            const content = document.getElementById('question-content').value.trim();
            
            console.log('질문 등록 시도:', { title, content, currentUser });
            
            if (!title) {
                showToast('질문 제목을 입력해주세요.', 'error');
                return;
            }
            
            if (!content) {
                showToast('질문 내용을 입력해주세요.', 'error');
                return;
            }
            
            if (!currentUser) {
                showToast('로그인이 필요합니다.', 'error');
                window.location.href = '/';
                return;
            }
            
            // 제출 시작
            isSubmitting = true;
            const submitBtn = document.getElementById('submit-question');
            submitBtn.disabled = true;
            submitBtn.textContent = '등록 중...';
            
            try {
                // 이미지 업로드
                const imageUrls = [];
                for (const file of selectedImages) {
                    const formData = new FormData();
                    formData.append('image', file);
                    
                    const uploadResponse = await fetch('/api/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (uploadResponse.ok) {
                        const result = await uploadResponse.json();
                        imageUrls.push(result.imageUrl);
                    }
                }
                
                // 질문 등록
                console.log('질문 등록 요청:', { title, content, images: imageUrls });
                
                // CSRF 토큰 가져오기
                const csrfToken = window.csrfToken || document.querySelector('meta[name="csrf-token"]')?.content;
                console.log('사용할 CSRF 토큰:', csrfToken);
                
                const response = await fetch('/api/questions', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        title,
                        content,
                        images: imageUrls,
                        _csrf: csrfToken
                    })
                });
                
                console.log('질문 등록 응답:', response.status, response.statusText);
                
                if (response.ok) {
                    showToast('질문이 등록되었습니다! +3 포인트 획득!', 'success');
                    
                    // 레벨업 체크
                    setTimeout(async () => {
                        await checkLevelUp();
                    }, 1000);
                    
                    // 질문 목록으로 이동
                    setTimeout(() => {
                        window.location.href = '/questions.html';
                    }, 2000);
                } else if (response.status === 429) {
                    showToast('잠시 후 다시 시도해주세요.', 'warning');
                } else {
                    const error = await response.json();
                    throw new Error(error.error || '질문 등록에 실패했습니다.');
                }
            } catch (error) {
                console.error('질문 등록 실패:', error);
                showToast(error.message || '질문 등록에 실패했습니다.', 'error');
            } finally {
                // 제출 완료 후 플래그 해제
                isSubmitting = false;
                submitBtn.disabled = false;
                submitBtn.textContent = '질문 등록하기';
            }
        }
        
        // 레벨업 체크 함수
        async function checkLevelUp() {
            try {
                const response = await fetch('/api/user/level');
                if (response.ok) {
                    const levelInfo = await response.json();
                    
                    if (currentUser && currentUser.levelInfo) {
                        const oldLevel = currentUser.levelInfo.level;
                        const newLevel = levelInfo.level;
                        
                        if (newLevel > oldLevel) {
                            showLevelUpModal(newLevel, levelInfo.title, `Level ${newLevel} 달성!`);
                        }
                    }
                }
            } catch (error) {
                console.error('레벨업 체크 실패:', error);
            }
        }
        
        // 레벨업 모달 표시 함수
        function showLevelUpModal(level, title, message) {
            const modal = document.createElement('div');
            modal.className = 'level-up-modal';
            modal.innerHTML = `
                <div class="level-up-content">
                    <div class="level-up-icon">🎉</div>
                    <h2 class="level-up-title">레벨업!</h2>
                    <div class="level-up-badge">Level ${level}</div>
                    <p class="level-up-message">${message}</p>
                    <p class="level-up-message">새로운 칭호: <strong>"${title}"</strong></p>
                    <button class="primary-btn" onclick="this.closest('.level-up-modal').remove()">확인</button>
                </div>
            `;
            document.body.appendChild(modal);
            
            setTimeout(() => {
                if (modal.parentNode) {
                    modal.remove();
                }
            }, 5000);
        }
        
        // 토스트 메시지 함수
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span>${message}</span>`;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>