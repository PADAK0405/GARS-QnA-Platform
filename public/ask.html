<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gaon QandA - ì§ˆë¬¸í•˜ê¸°</title>
    <meta name="csrf-token" content="">
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700&display=swap" rel="stylesheet">
    <meta name="description" content="Gaon QandAì—ì„œ ê¶ê¸ˆí•œ ì ì„ ì§ˆë¬¸í•˜ê³  ì»¤ë®¤ë‹ˆí‹°ì˜ ë„ì›€ì„ ë°›ì•„ë³´ì„¸ìš”">
</head>
<body>
    <nav class="navbar">
        <a href="/" class="navbar-brand">Gaon QandA</a>
        <div id="auth-container"></div>
    </nav>
    <div class="container">
        <h1 class="page-title">ìƒˆë¡œìš´ ì§ˆë¬¸í•˜ê¸°</h1>
        <div class="card" id="question-form">
            <div class="form-group">
                <label for="question-title" style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-color);">ì§ˆë¬¸ ì œëª©</label>
                <input type="text" id="question-title" placeholder="ëª…í™•í•˜ê³  ê°„ê²°í•œ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            <div class="form-group">
                <label for="question-content" style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-color);">ì§ˆë¬¸ ë‚´ìš©</label>
                <textarea id="question-content" placeholder="ê¶ê¸ˆí•œ ë‚´ìš©ì„ ìì„¸íˆ ì‘ì„±í•´ì£¼ì„¸ìš”. êµ¬ì²´ì ì¼ìˆ˜ë¡ ë” ì¢‹ì€ ë‹µë³€ì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤."></textarea>
            </div>
            <div class="form-group">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-color);">ì´ë¯¸ì§€ ì²¨ë¶€ (ì„ íƒ)</label>
                <input type="file" id="question-image" accept="image/*" multiple style="display: none;">
                <button type="button" id="upload-image-btn" class="secondary-btn">ì´ë¯¸ì§€ ì„ íƒ</button>
                <div id="image-preview" class="image-preview"></div>
            </div>
            <button id="submit-question">ì§ˆë¬¸ ë“±ë¡í•˜ê¸°</button>
        </div>
    </div>
    <script src="protection.js"></script>
    <script src="script.js"></script>
    <script src="csrf.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', setupAskPage);
        
        let selectedImages = [];
        
        async function setupAskPage() {
            // script.jsì—ì„œ ì´ë¯¸ currentUserê°€ ì„¤ì •ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
            if (typeof currentUser === 'undefined' || !currentUser) {
                // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
                try {
                    const response = await fetch('/api/user');
                    if (!response.ok) {
                        window.location.href = '/';
                        return;
                    }
                    currentUser = await response.json();
                    console.log('ask.htmlì—ì„œ ì‚¬ìš©ì ì •ë³´ ë¡œë“œ:', currentUser);
                } catch (error) {
                    console.error('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
                    window.location.href = '/';
                    return;
                }
            } else {
                console.log('script.jsì—ì„œ ì´ë¯¸ ë¡œë“œëœ ì‚¬ìš©ì ì •ë³´ ì‚¬ìš©:', currentUser);
            }
            
            setupEventListeners();
        }
        
        function setupEventListeners() {
            // ì´ë¯¸ì§€ ì—…ë¡œë“œ ë²„íŠ¼
            const uploadBtn = document.getElementById('upload-image-btn');
            const imageInput = document.getElementById('question-image');
            
            uploadBtn.addEventListener('click', () => imageInput.click());
            imageInput.addEventListener('change', handleImageSelect);
            
            // ì§ˆë¬¸ ì œì¶œ ë²„íŠ¼
            const submitBtn = document.getElementById('submit-question');
            submitBtn.addEventListener('click', submitQuestion);
            
        }
        
        
        function handleImageSelect(event) {
            const files = Array.from(event.target.files);
            const maxFiles = 5;
            
            if (files.length > maxFiles) {
                showToast(`ìµœëŒ€ ${maxFiles}ê°œì˜ ì´ë¯¸ì§€ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`, 'error');
                return;
            }
            
            selectedImages = files;
            displayImagePreviews();
        }
        
        function displayImagePreviews() {
            const preview = document.getElementById('image-preview');
            preview.innerHTML = '';
            
            selectedImages.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.width = '100px';
                    img.style.height = '100px';
                    img.style.objectFit = 'cover';
                    img.style.borderRadius = '8px';
                    img.style.margin = '4px';
                    img.style.cursor = 'pointer';
                    
                    img.addEventListener('click', () => removeImage(index));
                    preview.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
        }
        //ë‚˜ë„ ì´ê²Œ ë­”ì§€ ëª¨ë¥´ê² ë‹¤
        function removeImage(index) {
            selectedImages.splice(index, 1);
            displayImagePreviews();
        }
        
        let isSubmitting = false; // ì¤‘ë³µ ì œì¶œ ë°©ì§€ í”Œë˜ê·¸
        
        async function submitQuestion() {
            // ì´ë¯¸ ì œì¶œ ì¤‘ì´ë©´ ë¬´ì‹œ
            if (isSubmitting) {
                console.log('ì´ë¯¸ ì œì¶œ ì¤‘ì…ë‹ˆë‹¤. ì¤‘ë³µ ì œì¶œ ë°©ì§€');
                return;
            }
            
            const title = document.getElementById('question-title').value.trim();
            const content = document.getElementById('question-content').value.trim();
            
            console.log('ì§ˆë¬¸ ë“±ë¡ ì‹œë„:', { title, content, currentUser });
            
            if (!title) {
                showToast('ì§ˆë¬¸ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            if (!content) {
                showToast('ì§ˆë¬¸ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            if (!currentUser) {
                showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
                window.location.href = '/';
                return;
            }
            
            // ì œì¶œ ì‹œì‘
            isSubmitting = true;
            const submitBtn = document.getElementById('submit-question');
            submitBtn.disabled = true;
            submitBtn.textContent = 'ë“±ë¡ ì¤‘...';
            
            try {
                // ì´ë¯¸ì§€ ì—…ë¡œë“œ
                const imageUrls = [];
                for (const file of selectedImages) {
                    const formData = new FormData();
                    formData.append('image', file);
                    
                    const uploadResponse = await fetch('/api/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (uploadResponse.ok) {
                        const result = await uploadResponse.json();
                        imageUrls.push(result.imageUrl);
                    }
                }
                
                // ì§ˆë¬¸ ë“±ë¡
                console.log('ì§ˆë¬¸ ë“±ë¡ ìš”ì²­:', { title, content, images: imageUrls });
                
                // CSRF í† í° ê°€ì ¸ì˜¤ê¸°
                const csrfToken = window.csrfToken || document.querySelector('meta[name="csrf-token"]')?.content;
                console.log('ì‚¬ìš©í•  CSRF í† í°:', csrfToken);
                
                const response = await fetch('/api/questions', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        title,
                        content,
                        images: imageUrls,
                        _csrf: csrfToken
                    })
                });
                
                console.log('ì§ˆë¬¸ ë“±ë¡ ì‘ë‹µ:', response.status, response.statusText);
                
                if (response.ok) {
                    showToast('ì§ˆë¬¸ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! +3 í¬ì¸íŠ¸ íšë“!', 'success');
                    
                    // ë ˆë²¨ì—… ì²´í¬
                    setTimeout(async () => {
                        await checkLevelUp();
                    }, 1000);
                    
                    // ì§ˆë¬¸ ëª©ë¡ìœ¼ë¡œ ì´ë™
                    setTimeout(() => {
                        window.location.href = '/questions.html';
                    }, 2000);
                } else if (response.status === 429) {
                    showToast('ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'warning');
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'ì§ˆë¬¸ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ì§ˆë¬¸ ë“±ë¡ ì‹¤íŒ¨:', error);
                showToast(error.message || 'ì§ˆë¬¸ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            } finally {
                // ì œì¶œ ì™„ë£Œ í›„ í”Œë˜ê·¸ í•´ì œ
                isSubmitting = false;
                submitBtn.disabled = false;
                submitBtn.textContent = 'ì§ˆë¬¸ ë“±ë¡í•˜ê¸°';
            }
        }
        
        // ë ˆë²¨ì—… ì²´í¬ í•¨ìˆ˜
        async function checkLevelUp() {
            try {
                const response = await fetch('/api/user/level');
                if (response.ok) {
                    const levelInfo = await response.json();
                    
                    if (currentUser && currentUser.levelInfo) {
                        const oldLevel = currentUser.levelInfo.level;
                        const newLevel = levelInfo.level;
                        
                        if (newLevel > oldLevel) {
                            showLevelUpModal(newLevel, levelInfo.title, `Level ${newLevel} ë‹¬ì„±!`);
                        }
                    }
                }
            } catch (error) {
                console.error('ë ˆë²¨ì—… ì²´í¬ ì‹¤íŒ¨:', error);
            }
        }
        
        // ë ˆë²¨ì—… ëª¨ë‹¬ í‘œì‹œ í•¨ìˆ˜
        function showLevelUpModal(level, title, message) {
            const modal = document.createElement('div');
            modal.className = 'level-up-modal';
            modal.innerHTML = `
                <div class="level-up-content">
                    <div class="level-up-icon">ğŸ‰</div>
                    <h2 class="level-up-title">ë ˆë²¨ì—…!</h2>
                    <div class="level-up-badge">Level ${level}</div>
                    <p class="level-up-message">${message}</p>
                    <p class="level-up-message">ìƒˆë¡œìš´ ì¹­í˜¸: <strong>"${title}"</strong></p>
                    <button class="primary-btn" onclick="this.closest('.level-up-modal').remove()">í™•ì¸</button>
                </div>
            `;
            document.body.appendChild(modal);
            
            setTimeout(() => {
                if (modal.parentNode) {
                    modal.remove();
                }
            }, 5000);
        }
        
        // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í•¨ìˆ˜
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span>${message}</span>`;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>